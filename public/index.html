<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Plant Health Analyzer</title>
    <!-- Tailwind CSS -->
    <script src="https://cdn.tailwindcss.com"></script>
    <!-- Google Fonts -->
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@300;400;500;600;700&family=Fraunces:opsz,wght@9..144,400;600;700&display=swap" rel="stylesheet">
    <!-- Markdown Parser -->
    <script src="https://cdn.jsdelivr.net/npm/marked/marked.min.js"></script>
    <!-- Lucide Icons -->
    <script src="https://unpkg.com/lucide@latest"></script>
    <script>
        tailwind.config = {
            theme: {
                extend: {
                    fontFamily: {
                        sans: ['Inter', 'sans-serif'],
                        serif: ['Fraunces', 'serif'],
                    },
                    colors: {
                        plant: {
                            50: '#f0fdf4',
                            100: '#dcfce7',
                            500: '#22c55e',
                            600: '#16a34a',
                            700: '#15803d',
                            800: '#166534',
                            900: '#14532d',
                        }
                    }
                }
            }
        }
    </script>
    <style>
        .image-compare {
            position: relative;
            width: 100%;
            height: 400px;
            background: #f3f4f6;
            border-radius: 0.75rem;
            overflow: hidden;
        }
        .image-compare img {
            position: absolute;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            object-fit: contain;
        }
        /* Custom range slider styling */
        input[type=range] {
            -webkit-appearance: none; 
            background: transparent; 
        }
        input[type=range]::-webkit-slider-thumb {
            -webkit-appearance: none;
            height: 20px;
            width: 20px;
            border-radius: 50%;
            background: #16a34a;
            cursor: pointer;
            margin-top: -8px; 
            box-shadow: 0 2px 6px rgba(0,0,0,0.2);
        }
        input[type=range]::-webkit-slider-runnable-track {
            width: 100%;
            height: 4px;
            background: #d1d5db;
            border-radius: 2px;
        }
    </style>
</head>
<body class="bg-gray-50 min-h-screen text-gray-800 font-sans">

    <!-- SETUP VIEW (No Data) -->
    <div id="setupView" class="hidden min-h-screen flex items-center justify-center p-4">
        <div class="bg-white p-8 rounded-2xl shadow-xl w-full max-w-md border border-gray-100">
            <div class="text-center mb-8">
                <div class="inline-flex items-center justify-center w-16 h-16 bg-plant-100 rounded-full mb-4 text-plant-600">
                    <i data-lucide="sprout" class="w-8 h-8"></i>
                </div>
                <h1 class="font-serif text-2xl font-bold text-gray-900 mb-2">Plant Profile</h1>
                <p class="text-gray-500 text-sm">Let's set up your plant tracker. Enter the details below to get started.</p>
            </div>
            
            <div class="space-y-5">
                <div>
                    <label class="block text-xs font-semibold text-gray-500 uppercase tracking-wider mb-2">Plant Name</label>
                    <input type="text" id="setupName" class="w-full px-4 py-3 bg-gray-50 border border-gray-200 rounded-xl focus:ring-2 focus:ring-plant-500 focus:border-plant-500 outline-none transition" placeholder="e.g. Chili Pepper">
                </div>
                
                <div class="grid grid-cols-2 gap-4">
                    <div>
                        <label class="block text-xs font-semibold text-gray-500 uppercase tracking-wider mb-2">City</label>
                        <div class="relative">
                            <input type="text" id="setupCity" class="w-full px-4 py-3 bg-gray-50 border border-gray-200 rounded-xl focus:ring-2 focus:ring-plant-500 focus:border-plant-500 outline-none transition pr-10" placeholder="San Francisco">
                            <button id="setupLocBtn" class="absolute right-2 top-2 text-gray-400 hover:text-plant-600 p-2" title="Auto-detect Location">
                                <i data-lucide="map-pin" class="w-4 h-4"></i>
                            </button>
                        </div>
                    </div>
                    <div>
                        <label class="block text-xs font-semibold text-gray-500 uppercase tracking-wider mb-2">Location</label>
                        <input type="text" id="setupLocation" class="w-full px-4 py-3 bg-gray-50 border border-gray-200 rounded-xl focus:ring-2 focus:ring-plant-500 focus:border-plant-500 outline-none transition" placeholder="Living Room">
                    </div>
                </div>

                <button id="startTrackingBtn" class="w-full bg-plant-600 hover:bg-plant-700 text-white py-4 rounded-xl font-bold text-lg shadow-lg hover:shadow-xl transition transform active:scale-95 flex items-center justify-center gap-2">
                    <span>Start Tracking</span> <i data-lucide="rocket" class="w-5 h-5"></i>
                </button>
            </div>
        </div>
    </div>

    <!-- DASHBOARD VIEW (Data Exists) -->
    <div id="dashboardView" class="hidden">
    <!-- Header -->
    <header class="bg-white border-b border-gray-200 sticky top-0 z-50">
        <div class="max-w-7xl mx-auto px-4 sm:px-6 lg:px-8 h-16 flex items-center justify-between">
            <div class="flex items-center gap-4">
                <div class="flex items-center gap-2">
                    <span class="text-plant-600"><i data-lucide="sprout" class="w-6 h-6"></i></span>
                    <h1 class="font-serif text-xl font-bold text-gray-900 tracking-tight hidden md:block">Plant Health Analyzer</h1>
                </div>
                
                <!-- Profile Button -->
                <button id="profileBtn" class="flex items-center gap-2 px-3 py-1.5 bg-gray-50 hover:bg-gray-100 text-gray-700 rounded-lg text-sm font-medium transition border border-gray-200">
                    <i data-lucide="user" class="w-4 h-4"></i> Plant Profile
                </button>
            </div>
            
            <!-- Day Navigation -->
            <div class="flex items-center bg-gray-100 rounded-lg p-1">
                <button id="prevDay" class="px-3 py-1.5 text-sm font-medium text-gray-600 hover:text-gray-900 hover:bg-white rounded-md transition disabled:opacity-50 flex items-center gap-1">
                    <i data-lucide="chevron-left" class="w-4 h-4"></i> Prev
                </button>
                <span id="dayLabel" class="px-4 text-sm font-semibold text-gray-900 min-w-[80px] text-center">Day 0</span>
                <button id="nextDay" class="px-3 py-1.5 text-sm font-medium text-gray-600 hover:text-gray-900 hover:bg-white rounded-md transition disabled:opacity-50 flex items-center gap-1">
                    Next <i data-lucide="chevron-right" class="w-4 h-4"></i>
                </button>
            </div>
        </div>
    </header>

    <main class="max-w-7xl mx-auto px-4 sm:px-6 lg:px-8 py-8">
        
        <!-- Status Notification -->
        <div id="status" class="hidden mb-6 p-4 rounded-lg text-sm font-medium text-center transition-all duration-300"></div>

        <div class="grid grid-cols-1 lg:grid-cols-12 gap-8">
            
            <!-- LEFT COLUMN: Main Plant View (8 cols) -->
            <div class="lg:col-span-8 space-y-6">
                
                <!-- Plant Setup / Info Card -->
                <div class="bg-white rounded-xl shadow-sm border border-gray-200 overflow-hidden">
                    <div class="p-6 border-b border-gray-100 flex justify-between items-center">
                        <h2 class="font-serif text-lg font-semibold text-gray-900">Plant Details</h2>
                        <button id="saveInfoBtn" class="text-sm text-plant-600 hover:text-plant-700 font-medium">Save Changes</button>
                    </div>
                    <div class="p-6 grid grid-cols-1 md:grid-cols-2 gap-6">
                        <div>
                            <label class="block text-xs font-semibold text-gray-500 uppercase tracking-wider mb-2">Plant Name</label>
                            <input type="text" id="plantName" class="w-full px-4 py-2 bg-gray-50 border border-gray-200 rounded-lg focus:ring-2 focus:ring-plant-500 focus:border-plant-500 outline-none transition" placeholder="e.g. Chili Pepper">
                        </div>
                        <div>
                            <label class="block text-xs font-semibold text-gray-500 uppercase tracking-wider mb-2">Location</label>
                            <div class="flex gap-2">
                                <div class="relative flex-1">
                                    <input type="text" id="city" class="w-full px-4 py-2 bg-gray-50 border border-gray-200 rounded-lg focus:ring-2 focus:ring-plant-500 focus:border-plant-500 outline-none transition pr-8" placeholder="City">
                                    <button id="dashboardLocBtn" class="absolute right-1 top-1 text-gray-400 hover:text-plant-600 p-1" title="Auto-detect Location">
                                        <i data-lucide="map-pin" class="w-4 h-4"></i>
                                    </button>
                                </div>
                                <input type="text" id="indoorLocation" class="w-full px-4 py-2 bg-gray-50 border border-gray-200 rounded-lg focus:ring-2 focus:ring-plant-500 focus:border-plant-500 outline-none transition" placeholder="Room">
                            </div>
                        </div>
                    </div>
                </div>

                <!-- Image Visualization Card -->
                <div class="bg-white rounded-xl shadow-sm border border-gray-200 overflow-hidden">
                    <div class="p-6 border-b border-gray-100 flex justify-between items-center">
                        <h2 class="font-serif text-lg font-semibold text-gray-900">Growth Visualization</h2>
                        <div class="flex gap-2">
                            <label for="plantImage" class="cursor-pointer px-4 py-2 bg-gray-100 hover:bg-gray-200 text-gray-700 text-sm font-medium rounded-lg transition flex items-center gap-2">
                                <i data-lucide="camera" class="w-4 h-4"></i> Upload Image
                            </label>
                            <input type="file" id="plantImage" class="hidden" accept="image/*">
                        </div>
                    </div>
                    
                    <div class="p-6">
                        <!-- Image Container -->
                        <div class="image-compare relative bg-gray-100 rounded-lg flex items-center justify-center text-center">
                            <img id="predictedImg" class="absolute inset-0 w-full h-full object-contain" style="display:none;" alt="Predicted">
                            <img id="realImg" class="absolute inset-0 w-full h-full object-contain relative z-10" style="display:none;" alt="Real">
                            
                            <!-- Empty State -->
                            <div id="noImageMsg" class="text-gray-400 p-8 flex flex-col items-center">
                                <i data-lucide="image" class="w-12 h-12 mb-3 text-gray-300"></i>
                                <p>No image for this day.</p>
                                <p class="text-sm">Upload a photo to start analyzing.</p>
                            </div>
                        </div>

                        <!-- Comparison Slider -->
                        <div id="sliderContainer" class="mt-6 hidden">
                            <div class="flex justify-between text-xs font-semibold text-gray-500 uppercase tracking-wider mb-2">
                                <span>Real (Today)</span>
                                <span>Predicted (Tomorrow)</span>
                            </div>
                            <input type="range" id="compareSlider" min="0" max="100" value="0" class="w-full h-2 bg-gray-200 rounded-lg appearance-none cursor-pointer">
                        </div>

                        <!-- Predict Prompt -->
                        <div id="predictPrompt" class="hidden mt-6 bg-purple-50 border border-purple-100 rounded-lg p-4 flex items-center justify-between">
                            <div class="flex items-center gap-3">
                                <span class="text-purple-600"><i data-lucide="sparkles" class="w-6 h-6"></i></span>
                                <span class="text-sm text-purple-900">Generate a prediction for tomorrow's growth?</span>
                            </div>
                            <button id="predictBtn" class="px-4 py-2 bg-purple-600 hover:bg-purple-700 text-white text-sm font-medium rounded-lg transition">
                                Generate
                            </button>
                        </div>
                    </div>
                </div>

                <!-- Notes / Feedback -->
                <div class="bg-white rounded-xl shadow-sm border border-gray-200 p-6">
                    <label class="block text-xs font-semibold text-gray-500 uppercase tracking-wider mb-2">Daily Notes</label>
                    <textarea id="feedback" rows="3" class="w-full px-4 py-3 bg-gray-50 border border-gray-200 rounded-lg focus:ring-2 focus:ring-plant-500 focus:border-plant-500 outline-none transition" placeholder="Observations about the plant's health..."></textarea>
                </div>
            </div>

            <!-- RIGHT COLUMN: Insights & Widgets (4 cols) -->
            <div class="lg:col-span-4 space-y-6">
                
                <!-- Main Action -->
                <div class="bg-white rounded-xl shadow-sm border border-gray-200 p-6 space-y-4">
                    <button id="analyzeAllBtn" class="w-full bg-plant-600 hover:bg-plant-700 text-white py-3 px-4 rounded-xl shadow-sm font-semibold text-lg transition flex items-center justify-center gap-2 group">
                        <i data-lucide="wand-2" class="w-5 h-5"></i> <span>Analyze Full Plant</span>
                    </button>
                    
                    <!-- Specific Analysis Dropdown -->
                    <div class="flex gap-2">
                        <select id="analysisType" class="flex-1 bg-gray-50 border border-gray-200 text-gray-700 text-sm rounded-lg focus:ring-plant-500 focus:border-plant-500 block p-2.5">
                            <option value="">Select specific analysis...</option>
                            <option value="weather">‚òÅÔ∏è Weather Data</option>
                            <option value="leafcount">üçÉ Leaf Count</option>
                            <option value="color">üé® Plant Color</option>
                            <option value="infections">üî¨ Health Check</option>
                            <option value="growth">üå± Growth Stage</option>
                        </select>
                        <button id="analyzeSpecificBtn" class="bg-gray-100 hover:bg-gray-200 text-gray-800 font-medium rounded-lg text-sm px-4 py-2 transition disabled:opacity-50 disabled:cursor-not-allowed" disabled>
                            Run
                        </button>
                    </div>

                    <button id="identifyBtn" class="w-full bg-teal-600 hover:bg-teal-700 text-white py-3 px-4 rounded-xl shadow-sm font-semibold text-lg transition flex items-center justify-center gap-2 group mt-2">
                        <i data-lucide="search" class="w-5 h-5"></i> <span>Identify Plant Species</span>
                    </button>
                    
                    <!-- Identification Results -->
                    <div id="identifyResults" class="hidden mt-4 space-y-3 max-h-96 overflow-y-auto"></div>

                    <!-- Get Actionable Insights Button -->
                    <button id="insightsBtn" class="w-full bg-amber-500 hover:bg-amber-600 text-white py-3 px-4 rounded-xl shadow-sm font-semibold text-lg transition flex items-center justify-center gap-2 group mt-2">
                        <i data-lucide="lightbulb" class="w-5 h-5"></i> <span>Get Actionable Insights</span>
                    </button>
                    
                    <!-- Insights Results -->
                    <div id="insightsResults" class="hidden mt-4 bg-amber-50 border border-amber-200 rounded-xl p-4">
                        <div class="flex items-center gap-2 mb-3">
                            <i data-lucide="lightbulb" class="w-5 h-5 text-amber-600"></i>
                            <h4 class="font-semibold text-amber-900">Today's Insights</h4>
                        </div>
                        <div id="insightsContent" class="text-sm text-amber-900 leading-relaxed prose prose-sm max-w-none"></div>
                    </div>
                </div>

                <!-- Weather Widget -->
                <div class="bg-white rounded-xl shadow-sm border border-gray-200 p-6">
                    <div class="flex items-center justify-between mb-4">
                        <h3 class="font-serif font-semibold text-gray-900">Weather</h3>
                        <span class="text-xs bg-blue-50 text-blue-600 px-2 py-1 rounded-full font-medium">Local</span>
                    </div>
                    
                    <div id="weatherContent" class="space-y-4">
                        <div class="text-gray-400 text-sm italic">No weather data. Click Analyze.</div>
                    </div>
                </div>

                <!-- Sunlight Widget -->
                <div class="bg-white rounded-xl shadow-sm border border-gray-200 p-6">
                    <div class="flex items-center justify-between mb-4">
                        <h3 class="font-serif font-semibold text-gray-900">Daily Sunlight</h3>
                        <span class="text-yellow-500"><i data-lucide="sun" class="w-6 h-6"></i></span>
                    </div>
                    
                    <div id="sunlightContent" class="flex flex-col items-center">
                        <div class="text-gray-400 text-sm italic w-full text-left">No sunlight data.</div>
                    </div>
                </div>

                <!-- Quick Stats Grid -->
                <div class="grid grid-cols-2 gap-4">
                    <!-- Leaf Count -->
                    <div class="bg-white p-4 rounded-xl shadow-sm border border-gray-200">
                        <div class="text-gray-400 text-xs font-medium uppercase mb-1">Leaves</div>
                        <div id="leafDisplay" class="text-2xl font-serif font-bold text-gray-900">-</div>
                        <div class="text-xs text-green-600 mt-1">Count</div>
                    </div>

                    <!-- Growth Stage -->
                    <div class="bg-white p-4 rounded-xl shadow-sm border border-gray-200">
                        <div class="text-gray-400 text-xs font-medium uppercase mb-1">Stage</div>
                        <div id="stageDisplay" class="text-lg font-serif font-bold text-gray-900 leading-tight">-</div>
                    </div>

                    <!-- Color -->
                    <div class="col-span-2 bg-white p-4 rounded-xl shadow-sm border border-gray-200 flex items-center justify-between">
                        <div>
                            <div class="text-gray-400 text-xs font-medium uppercase mb-1">Avg Color</div>
                            <div id="colorHex" class="text-sm font-mono text-gray-600">-</div>
                        </div>
                        <div id="colorBox" class="w-10 h-10 rounded-lg border border-gray-200 bg-gray-100 shadow-sm"></div>
                    </div>
                </div>

                <!-- Health Status -->
                <div class="bg-white rounded-xl shadow-sm border border-gray-200 p-6">
                    <h3 class="font-serif font-semibold text-gray-900 mb-3">Health Status</h3>
                    <div id="healthDisplay" class="p-3 bg-gray-50 rounded-lg text-sm text-gray-600 border border-gray-100">
                        No health analysis available.
                    </div>
                </div>

                <!-- About Plant -->
                <div class="bg-white rounded-xl shadow-sm border border-gray-200 p-6">
                    <div class="flex items-center justify-between mb-3">
                        <h3 class="font-serif font-semibold text-gray-900">About</h3>
                    </div>
                    <div id="aboutContent" class="text-sm text-gray-600 leading-relaxed max-h-40 overflow-y-auto pr-2">
                        Plant description will appear here after identification or enhancement.
                    </div>
                </div>
                
                <button id="clearBtn" class="w-full text-xs text-red-400 hover:text-red-600 py-2">Clear All Data</button>

            </div>
        </div>
    </main>
    </div> <!-- End Dashboard View -->

    <script>
        // --- State Management ---
        let currentDay = -1;
        let plantData = null;
        let currentFile = null;

        // --- Elements ---
        const els = {
            // Setup Elements
            setupView: document.getElementById('setupView'),
            dashboardView: document.getElementById('dashboardView'),
            setupName: document.getElementById('setupName'),
            setupCity: document.getElementById('setupCity'),
            setupLocation: document.getElementById('setupLocation'),
            startBtn: document.getElementById('startTrackingBtn'),
            setupLocBtn: document.getElementById('setupLocBtn'),

            // Header Elements
            profileBtn: document.getElementById('profileBtn'),
            dashboardLocBtn: document.getElementById('dashboardLocBtn'),

            // Dashboard Elements
            plantName: document.getElementById('plantName'),
            city: document.getElementById('city'),
            indoorLocation: document.getElementById('indoorLocation'),
            dayLabel: document.getElementById('dayLabel'),
            prevBtn: document.getElementById('prevDay'),
            nextBtn: document.getElementById('nextDay'),
            feedback: document.getElementById('feedback'),
            realImg: document.getElementById('realImg'),
            predictedImg: document.getElementById('predictedImg'),
            noImageMsg: document.getElementById('noImageMsg'),
            sliderContainer: document.getElementById('sliderContainer'),
            compareSlider: document.getElementById('compareSlider'),
            fileInput: document.getElementById('plantImage'),
            weatherContent: document.getElementById('weatherContent'),
            sunlightContent: document.getElementById('sunlightContent'),
            leafDisplay: document.getElementById('leafDisplay'),
            colorBox: document.getElementById('colorBox'),
            colorHex: document.getElementById('colorHex'),
            healthDisplay: document.getElementById('healthDisplay'),
            stageDisplay: document.getElementById('stageDisplay'),
            aboutContent: document.getElementById('aboutContent'),
            predictPrompt: document.getElementById('predictPrompt'),
            status: document.getElementById('status')
        };

        // Initialize Icons
        function refreshIcons() {
            if (window.lucide) {
                lucide.createIcons();
            }
        }

        // --- Initialization ---
        loadPlantData();

        async function loadPlantData() {
            try {
                const res = await fetch('/api/plant');
                const data = await res.json();
                plantData = data.plant;
                
                if (plantData) {
                    currentDay = plantData.currentDay || 0;
                    if (currentDay < 0) currentDay = 0; 
                    fillGlobalInfo();
                    updateDisplay();
                } else {
                    currentDay = 0; 
                    updateDisplay();
                }
                refreshIcons();
            } catch (e) {
                console.error("Failed to load data", e);
            }
        }

        function fillGlobalInfo() {
            if (!plantData) return;
            // Fill Dashboard inputs
            els.plantName.value = plantData.name || '';
            els.city.value = plantData.city || '';
            els.indoorLocation.value = plantData.indoorLocation || '';
            
            // Fill Setup inputs (for editing cases or if we fall back)
            els.setupName.value = plantData.name || '';
            els.setupCity.value = plantData.city || '';
            els.setupLocation.value = plantData.indoorLocation || '';

            if (plantData.about) els.aboutContent.innerHTML = marked.parse(plantData.about);
        }

        // --- Core UI Updates ---
        function updateDisplay() {
            if (!plantData || !plantData.name) {
                currentDay = -1;
            }

            if (currentDay === -1) {
                els.setupView.classList.remove('hidden');
                els.dashboardView.classList.add('hidden');
                els.startBtn.innerHTML = (plantData && plantData.name ? 'Save Profile' : 'Start Tracking') + ' <i data-lucide="rocket" class="w-5 h-5 inline"></i>';
                refreshIcons();
                return; 
            }

            els.setupView.classList.add('hidden');
            els.dashboardView.classList.remove('hidden');

            els.dayLabel.textContent = `Day ${currentDay}`;
            els.prevBtn.disabled = currentDay <= 0;
            // No upper limit on days - plant can grow indefinitely
            els.nextBtn.disabled = false;

            loadDayData(currentDay);
            refreshIcons();
        }

        function loadDayData(day) {
            // Reset Views
            els.noImageMsg.style.display = 'block';
            els.realImg.style.display = 'none';
            els.realImg.style.opacity = '1'; 
            els.predictedImg.style.display = 'none';
            els.sliderContainer.style.display = 'none';
            els.predictPrompt.style.display = 'none';
            resetWidgets();

            if (!plantData || !plantData.days) return;
            const dayKey = `day${day}`;
            const dayData = plantData.days[dayKey] || {};

            els.feedback.value = dayData.feedback || '';

            const predictedSrc = dayData.predictedImage;
            
            if (dayData.image) {
                els.realImg.src = dayData.image;
                els.realImg.style.display = 'block';
                els.noImageMsg.style.display = 'none';

                if (predictedSrc) {
                    els.predictedImg.src = predictedSrc;
                    els.predictedImg.style.display = 'block';
                    els.sliderContainer.style.display = 'block';
                    els.compareSlider.value = 0;
                    updateSliderOpacity(0);
                } else {
                    els.predictPrompt.style.display = 'flex';
                }
            }

            if (dayData.weather) renderWeather(dayData.weather);
            if (dayData.leafCount) els.leafDisplay.textContent = dayData.leafCount;
            if (dayData.plantColor) {
                els.colorBox.style.backgroundColor = dayData.plantColor;
                els.colorHex.textContent = dayData.plantColor;
            }
            if (dayData.growthStage) els.stageDisplay.textContent = dayData.growthStage;
            if (dayData.infections) {
                const isHealthy = dayData.infections.toLowerCase().includes('healthy');
                els.healthDisplay.innerHTML = `<span class="${isHealthy ? 'text-green-600 font-medium' : 'text-red-600 font-medium'}">${dayData.infections}</span>`;
            }
            refreshIcons();
        }

        function resetWidgets() {
            els.weatherContent.innerHTML = '<div class="text-gray-400 text-sm italic">No weather data. Click Analyze.</div>';
            els.sunlightContent.innerHTML = '<div class="text-gray-400 text-sm italic w-full text-left">No sunlight data.</div>';
            els.leafDisplay.textContent = '-';
            els.colorBox.style.backgroundColor = '#f3f4f6';
            els.colorHex.textContent = '-';
            els.stageDisplay.textContent = '-';
            els.healthDisplay.textContent = 'No health analysis available.';
        }

        function renderWeather(weatherString) {
            const getVal = (key) => {
                const regex = new RegExp(key + '[\\s:]+([^,]+)', 'i');
                const match = weatherString.match(regex);
                return match ? match[1].trim() : null;
            };

            const high = getVal('High') || '?';
            const low = getVal('Low') || '?';
            const humidity = getVal('Humidity') || '?';
            const sunrise = getVal('Sunrise') || '?';
            const sunset = getVal('Sunset') || '?';
            
            let daylightStr = getVal('Daylight') || '';
            let hours = 0;
            const hMatch = daylightStr.match(/(\d+)\s*hour/i);
            if (hMatch) hours += parseFloat(hMatch[1]);
            const mMatch = daylightStr.match(/(\d+)\s*minute/i);
            if (mMatch) hours += parseFloat(mMatch[1]) / 60;
            
            const displayHours = hours > 0 ? hours.toFixed(1) + 'h' : '-';

            let icon = 'cloud';
            const tempVal = parseInt(high);
            if (!isNaN(tempVal)) {
                if (tempVal > 75) icon = 'sun';
                else if (tempVal < 50) icon = 'cloud-rain';
            }

            const weatherHtml = `
                <div class="flex items-center justify-between mb-4">
                    <div class="flex items-center gap-3">
                        <span class="text-4xl shadow-sm bg-blue-50 rounded-lg p-2 flex items-center justify-center">
                            <i data-lucide="${icon}" class="w-8 h-8"></i>
                        </span>
                        <div>
                            <div class="text-2xl font-bold text-gray-900">${high}</div>
                            <div class="text-xs text-gray-500">Low: ${low}</div>
                        </div>
                    </div>
                    <div class="text-right">
                        <div class="text-sm font-medium text-blue-600 flex items-center justify-end gap-1"><i data-lucide="droplets" class="w-3 h-3"></i> ${humidity}</div>
                        <div class="text-xs text-gray-400 mt-1">Humidity</div>
                    </div>
                </div>
            `;
            els.weatherContent.innerHTML = weatherHtml;

            const percentage = Math.min((hours / 14) * 100, 100); 
            
            const sunlightHtml = `
                <div class="relative w-32 h-32 flex items-center justify-center mb-4">
                    <div class="absolute inset-0 rounded-full border-8 border-gray-100"></div>
                    <div class="absolute inset-0 rounded-full" style="background: conic-gradient(#eab308 ${percentage}%, transparent ${percentage}% 100%); mask: radial-gradient(transparent 55%, black 56%); -webkit-mask: radial-gradient(transparent 55%, black 56%);"></div>
                    
                    <div class="text-center z-10">
                        <div class="text-2xl font-serif font-bold text-gray-900">${displayHours}</div>
                        <div class="text-xs text-gray-400">Daylight</div>
                    </div>
                </div>
                
                <div class="w-full grid grid-cols-2 gap-4 text-xs">
                    <div class="flex flex-col items-center">
                        <span class="text-orange-400 text-lg mb-1"><i data-lucide="sunrise" class="w-5 h-5"></i></span>
                        <span class="text-gray-500">Sunrise</span>
                        <span class="font-semibold text-gray-700">${sunrise}</span>
                    </div>
                    <div class="flex flex-col items-center">
                        <span class="text-purple-400 text-lg mb-1"><i data-lucide="sunset" class="w-5 h-5"></i></span>
                        <span class="text-gray-500">Sunset</span>
                        <span class="font-semibold text-gray-700">${sunset}</span>
                    </div>
                </div>
            `;
            els.sunlightContent.innerHTML = sunlightHtml;
            refreshIcons();
        }

        els.prevBtn.addEventListener('click', () => { currentDay--; saveCurrentState().then(updateDisplay); });
        els.nextBtn.addEventListener('click', () => { currentDay++; saveCurrentState().then(updateDisplay); });
        
        els.profileBtn.addEventListener('click', () => {
            saveCurrentState().then(() => {
                currentDay = -1;
                updateDisplay();
            });
        });

        els.compareSlider.addEventListener('input', (e) => updateSliderOpacity(e.target.value));

        function updateSliderOpacity(val) {
            els.realImg.style.opacity = 1 - (val / 100);
        }

        function autoDetectLocation(inputElement) {
            if (!navigator.geolocation) {
                showStatus('Geolocation is not supported by your browser', 'error');
                return;
            }

            const btn = inputElement.parentElement.querySelector('button');
            btn.disabled = true;
            btn.style.opacity = '0.5';
            showStatus('Requesting location access...', 'info');

            navigator.geolocation.getCurrentPosition(async (position) => {
                const { latitude, longitude } = position.coords;
                try {
                    showStatus('Fetching city details...', 'info');
                    const res = await fetch(`https://nominatim.openstreetmap.org/reverse?format=json&lat=${latitude}&lon=${longitude}`);
                    const data = await res.json();
                    
                    if (data && data.address) {
                        const city = data.address.city || data.address.town || data.address.village || data.address.hamlet || data.address.county;
                        if (city) {
                            inputElement.value = city;
                            showStatus(`Location detected: ${city}`, 'success');
                        } else {
                            throw new Error('City name not found for this location');
                        }
                    } else {
                        throw new Error('Invalid response from geocoding service');
                    }
                } catch (e) {
                    console.error(e);
                    showStatus('Could not determine city name.', 'error');
                } finally {
                    btn.disabled = false;
                    btn.style.opacity = '1';
                }
            }, (error) => {
                console.error("Geo Error:", error);
                let msg = 'Location error.';
                switch(error.code) {
                    case error.PERMISSION_DENIED: msg = 'User denied location request.'; break;
                    case error.POSITION_UNAVAILABLE: msg = 'Location info unavailable.'; break;
                    case error.TIMEOUT: msg = 'Location request timed out.'; break;
                }
                showStatus(msg, 'error');
                btn.disabled = false;
                btn.style.opacity = '1';
            });
        }

        els.setupLocBtn.addEventListener('click', () => autoDetectLocation(els.setupCity));
        els.dashboardLocBtn.addEventListener('click', () => autoDetectLocation(els.city));

        els.startBtn.addEventListener('click', async () => {
            els.startBtn.textContent = 'Creating Profile...';
            els.startBtn.disabled = true;
            try {
                const body = {
                    name: els.setupName.value,
                    city: els.setupCity.value,
                    indoorLocation: els.setupLocation.value,
                    dayOfPlanting: 'Day 0',
                    feedback: '',
                    image: null
                };
                const res = await fetch('/api/plant', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify(body)
                });
                await loadPlantData();
                showStatus('üå± Plant profile created!', 'success');
            } catch (e) {
                showStatus('Error creating plant: ' + e.message, 'error');
            } finally {
                els.startBtn.textContent = 'Start Tracking';
                els.startBtn.disabled = false;
                refreshIcons();
            }
        });

        document.getElementById('saveInfoBtn').addEventListener('click', async () => {
            await saveCurrentState();
            showStatus('Plant info saved!', 'success');
        });

        async function saveCurrentState() {
            let imageData = null;
            if (currentFile) {
                imageData = await new Promise(r => {
                    const reader = new FileReader();
                    reader.onload = e => r(e.target.result);
                    reader.readAsDataURL(currentFile);
                });
            }
            const body = {
                name: els.plantName.value,
                city: els.city.value,
                indoorLocation: els.indoorLocation.value,
                dayOfPlanting: `Day ${currentDay}`,
                feedback: els.feedback.value,
                image: imageData
            };
            await fetch('/api/plant', {
                method: 'POST',
                headers: { 'Content-Type': 'application/json' },
                body: JSON.stringify(body)
            });
        }

        els.fileInput.addEventListener('change', async (e) => {
            const file = e.target.files[0];
            if (!file) return;
            currentFile = file;
            const reader = new FileReader();
            reader.onload = (e) => {
                els.realImg.src = e.target.result;
                els.realImg.style.display = 'block';
                els.realImg.style.opacity = 1;
                els.noImageMsg.style.display = 'none';
            };
            reader.readAsDataURL(file);
            showStatus('Uploading...', 'info');
            await saveCurrentState();
            showStatus('Image uploaded!', 'success');
            els.predictPrompt.style.display = 'flex';
            refreshIcons();
        });

        document.getElementById('analyzeAllBtn').addEventListener('click', async () => {
             const btn = document.getElementById('analyzeAllBtn');
             const originalText = btn.innerHTML;
             btn.innerHTML = '<span><i data-lucide="bot" class="w-5 h-5 inline"></i> Analyzing...</span>';
             btn.disabled = true;
             refreshIcons();

            try {
                await saveCurrentState();
                const endpoints = [
                    '/api/plant/weather',
                    '/api/plant/leafcount',
                    '/api/plant/color', 
                    '/api/plant/growth',
                    '/api/plant/infections'
                ];
                const promises = endpoints.map(ep => fetch(ep, { method: 'POST' }).then(r => r.json()));
                const results = await Promise.allSettled(promises);
                let successCount = 0;
                results.forEach((res, idx) => {
                    if (res.status === 'fulfilled' && !res.value.error) successCount++;
                });
                await loadPlantData(); 
                showStatus(`Analysis complete (${successCount}/${endpoints.length} checks)`, 'success');
            } catch (err) {
                console.error(err);
                showStatus('Analysis failed: ' + err.message, 'error');
            } finally {
                btn.innerHTML = originalText;
                btn.disabled = false;
                refreshIcons();
            }
        });

        const analysisDropdown = document.getElementById('analysisType');
        const specificBtn = document.getElementById('analyzeSpecificBtn');
        analysisDropdown.addEventListener('change', (e) => {
            specificBtn.disabled = !e.target.value;
        });
        specificBtn.addEventListener('click', async () => {
             const type = analysisDropdown.value;
             if (!type) return;
             specificBtn.disabled = true;
             specificBtn.textContent = '...';
             try {
                 await saveCurrentState();
                 const res = await fetch(`/api/plant/${type}`, { method: 'POST' });
                 const data = await res.json();
                 if (data.error) throw new Error(data.error);
                 await loadPlantData();
                 showStatus('Analysis updated!', 'success');
             } catch (err) {
                 showStatus('Error: ' + err.message, 'error');
             } finally {
                 specificBtn.disabled = false;
                 specificBtn.textContent = 'Run';
             }
        });

        document.getElementById('predictBtn').addEventListener('click', async () => {
            const btn = document.getElementById('predictBtn');
            btn.textContent = 'Generating...';
            btn.disabled = true;
            try {
                 await fetch('/api/plant/predict', { method: 'POST' });
                 await loadPlantData();
                 showStatus('Prediction generated!', 'success');
            } catch (e) {
                showStatus('Error predicting', 'error');
            } finally {
                btn.textContent = 'Generate';
                btn.disabled = false;
            }
        });

        document.getElementById('identifyBtn').addEventListener('click', async () => {
             const btn = document.getElementById('identifyBtn');
             const originalText = btn.innerHTML;
             const resultsContainer = document.getElementById('identifyResults');
             btn.innerHTML = '<span><i data-lucide="search" class="w-5 h-5 inline"></i> Identifying...</span>';
             btn.disabled = true;
             resultsContainer.innerHTML = '';
             resultsContainer.classList.add('hidden');
             refreshIcons();

             try {
                await saveCurrentState();
                const res = await fetch('/api/plant/identify', { method: 'POST' });
                const data = await res.json();
                if (data.suggestions && data.suggestions.length > 0) {
                    resultsContainer.classList.remove('hidden');
                    let html = '<div class="text-sm font-bold text-gray-700 mb-2">Top Suggestions:</div>';
                    data.suggestions.forEach(s => {
                        let imgsHtml = '';
                        if (s.similar_images && s.similar_images.length) {
                             s.similar_images.forEach(img => {
                                 if (img.url) {
                                     imgsHtml += `<img src="${img.url}" class="w-16 h-16 object-cover rounded-md border border-gray-200" title="Reference Image">`;
                                 }
                             });
                        }
                        html += `
                        <div class="bg-gray-50 p-3 rounded-lg border border-gray-100 hover:border-teal-200 transition">
                            <div class="flex justify-between items-center mb-2">
                                <div class="font-medium text-gray-800 text-sm">#${s.rank} ${s.name}</div>
                                <span class="bg-teal-100 text-teal-800 text-xs px-2 py-1 rounded-full font-bold">${s.probability}%</span>
                            </div>
                            <div class="flex gap-2">${imgsHtml}</div>
                        </div>`;
                    });
                    resultsContainer.innerHTML = html;
                    const best = data.suggestions[0];
                    if (!els.plantName.value && best.probability > 20) {
                         els.plantName.value = best.name;
                         await saveCurrentState();
                         showStatus(`Auto-named: ${best.name}`, 'success');
                         await fetch('/api/plant/enhance', { method: 'POST' });
                         await loadPlantData();
                    }
                } else {
                    showStatus('No identification results found.', 'info');
                }
             } catch(e) { 
                 console.error(e);
                 showStatus('Identification failed.', 'error');
             } finally {
                 btn.innerHTML = originalText;
                 btn.disabled = false;
                 refreshIcons();
             }
        });

        document.getElementById('clearBtn').addEventListener('click', async () => {
            if(confirm('Clear all data?')) {
                await fetch('/api/plant/clear', { method: 'POST' });
                location.reload();
            }
        });

        // Get Actionable Insights
        document.getElementById('insightsBtn').addEventListener('click', async () => {
            const btn = document.getElementById('insightsBtn');
            const originalText = btn.innerHTML;
            const resultsContainer = document.getElementById('insightsResults');
            const contentContainer = document.getElementById('insightsContent');
            
            btn.innerHTML = '<span><i data-lucide="loader-2" class="w-5 h-5 inline animate-spin"></i> Getting Insights...</span>';
            btn.disabled = true;
            resultsContainer.classList.add('hidden');
            refreshIcons();

            try {
                await saveCurrentState();
                const res = await fetch('/api/plant/insights', { method: 'POST' });
                const data = await res.json();
                
                if (data.error) {
                    throw new Error(data.error);
                }
                
                if (data.insights) {
                    resultsContainer.classList.remove('hidden');
                    contentContainer.innerHTML = marked.parse(data.insights);
                    showStatus('üí° Insights generated!', 'success');
                } else {
                    showStatus('No insights available.', 'info');
                }
            } catch (e) {
                console.error(e);
                showStatus('Failed to get insights: ' + e.message, 'error');
            } finally {
                btn.innerHTML = originalText;
                btn.disabled = false;
                refreshIcons();
            }
        });

        function showStatus(msg, type) {
            const el = document.getElementById('status');
            el.textContent = msg;
            el.style.display = 'block';
            el.className = `mb-6 p-4 rounded-lg text-sm font-medium text-center transition-all duration-300 ${type === 'error' ? 'bg-red-50 text-red-600' : type === 'info' ? 'bg-blue-50 text-blue-600' : 'bg-green-50 text-green-600'}`;
            setTimeout(() => el.style.display = 'none', 3000);
        }

    </script>
</body>
</html>
